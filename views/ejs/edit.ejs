<% include head %>
<% include headContent %>

    <% var idField = adminpanel.configHelper.getIdentifierField(instance.config.model) %>
        <% var data = record %>
        <% var config = adminpanel.configHelper.getConfig() %>

            <div class="horizontal layout">
                <div class="flex">
                    <% var actionType = 'edit' %>
                    <% include mixin/globalActions %>
                </div>
            </div>
            <div class="layout">
                <div class="nav-header">
                    <a href="<%= instance.uri %>/">
                        <button raised class="btn">
                <i class="las la-long-arrow-alt-left"></i>
                <%= __("Back") %>
            </button>
                    </a>
                    <div class="nav-header-wrap">
                        <!-- <button class="btn-nav">
                Скрыть
                <i class="las la-eye-slash"></i>
            </button> -->
            <% if (havePermission(`delete-${instance.name}-instance`, req.session.UserAP)) { %>
                <a href="<%= instance.uri %>/remove/<%= record[idField] %>">
                    <button class="btn-nav">
                    <%= __("Delete") %>
                    <i class="las la-trash-alt"></i>
                </button></a>
            <% } %>
                    </div>
                </div>
                <form id="form" action="<%= instance.uri %>/edit/<%= record[idField] %>" method="POST" enctype="multipart/form-data">

                    <%# global variables %>
                    <script>
                        var jsonEditor = {};
                        var aceCounter = 0;
                        let editor = [];
                        let textarea = [];
                    </script>

                    <% Object.keys(fields).forEach(function(key) { %>
                        <% if ((!config.showORMtime) && (key === 'createdAt' || key === 'updatedAt')) return %>
                        <% var field = fields[key] %>
                            <% var value = adminpanel.viewHelper.getFieldValue(key, field, data) %>
                                <div class="admin-panel__title">
                                    <%= field.config.title %>
                                        <% if(fields[key].config.tooltip) {%>
                                            <a href="javascript:void(0)" role="tooltip" aria-haspopup="true" class="tooltip tooltip-md tooltip-top-right">
                                                <i class="las la-info-circle"></i>
                                                <span class="tooltip-content"><%=fields[key].config.tooltip%></span>
                                            </a>
                                            <% } %>
                                </div>
                                <div class="admin-panel__widget">
                                    <% include mixin/fieldWidget %>
                                </div>
                                <% }) %>
                                    <% if (adminpanel.configHelper.isCsrfEnabled()) { %>
                                        <div>
                                            <input class="clr-input" type="hidden" name="_csrf" value="<%= _csrf %>" />
                                        </div>
                                    <% } %>
                                    <p>
                                        <button raised class="btn-save" id="submit" onclick="submitForm()">
                    <%= __("Save") %>
            </button>
                                    </p>
                </form>
            </div>

            <script>
                function submitForm() {
                    // Assign JSONEditor value to form textarea
                    for (var id in jsonEditor) {
                        try {
                            var json = jsonEditor[id].get();
                            $('#form-' + id).val(JSON.stringify(json));
                        } catch (e) {
                            alert('JSON is invalid.');
                            $('#form-' + id).show().focus().hide();
                            jsonEditor[id].focus();
                            return false;
                        }
                    };
                    document.getElementById('form').submit();
                }
            </script>

            <% include footer %>
