<% include head %>
<% include headContent %>
<% var idField = adminpanel.configHelper.getIdentifierField(entity.config.model) %>
<% var data = record %>
<% var config = adminpanel.configHelper.getConfig() %>

<div class="horizontal layout">
    <div class="flex">
        <% var actionType = 'edit' %>
        <% include mixin/globalActions %>
    </div>
</div>
<div class="layout">
    <div class="nav-header">
        <a href="<%= entity.uri %>/">
            <button raised class="btn">
                <i class="las la-long-arrow-alt-left"></i>
                <%= __("Back") %>
            </button>
        </a>
        <div class="nav-header-wrap">
            <!-- <button class="btn-nav">
    Скрыть
    <i class="las la-eye-slash"></i>
</button> -->
            <% if (entity.config.remove && havePermission(`delete-${entity.name}-model`, req.session.UserAP)) { %>
                <a href="<%= entity.uri %>/remove/<%= record[idField] %>"
                   onclick="return confirm('<%= __('Are you sure?') %>')">
                    <button class="btn-nav">
                        <%= __("Delete") %>
                        <i class="las la-trash-alt"></i>
                    </button>
                </a>
            <% } %>
        </div>
    </div>
    <form id="form" action="<%= entity.uri %>/edit/<%= record[idField] %>" method="POST" enctype="multipart/form-data">

        <%# global variables %>
        <script>
            var jsonEditor = {};
            var aceCounter = 0;
            let editor = [];
            let textarea = [];
            var tables = {};
        </script>

        <% Object.keys(fields).forEach(function(key) { %>
            <% if ((!config.showORMtime) && (key === 'createdAt' || key === 'updatedAt')) return %>
            <% var field = fields[key] %>
            <% var value = adminpanel.viewHelper.getFieldValue(key, field, data) %>
            <div class="admin-panel__title">
                <%= __(field.config.title) %>
                <% if(fields[key].config.tooltip) { %>
                    <a href="javascript:void(0)" role="tooltip" aria-haspopup="true"
                       class="tooltip tooltip-md tooltip-top-right">
                        <i class="las la-info-circle"></i>
                        <span class="tooltip-content"><%= __(fields[key].config.tooltip) %></span>
                    </a>
                <% } %>
            </div>
            <% if (field.config.description) { %>
                <div class="admin-panel__description">
                    <%- __(field.config.description) %>
                </div>
            <% } %>
            <div class="admin-panel__widget">
                <% include mixin/fieldWidget %>
            </div>
        <% }) %>
        <% if (adminpanel.configHelper.isCsrfEnabled()) { %>
            <div>
                <input class="clr-input" type="hidden" name="_csrf" value="<%= _csrf %>"/>
            </div>
        <% } %>
        <p>
            <button raised class="btn-save" id="submit" onclick="submitForm()">
                <%= __("Save") %>
            </button>
        </p>
    </form>
</div>

<script>
    function submitForm() {
        // Assign JSONEditor value to form textarea
        for (var id in jsonEditor) {
            try {
                var json = jsonEditor[id].get();
                $('#form-' + id).val(JSON.stringify(json));
            } catch (e) {
                alert('JSON is invalid.');
                $('#form-' + id).show().focus().hide();
                jsonEditor[id].focus();
                return false;
            }
        }
        ;

        for (var id in tables) {
            try {
                var schema = tables[id].getSchema();
                var table = tables[id].getData();
                table = table.filter(item => {
                    return !([...new Set(item)].length === 1 && [...new Set(item)][0] === null);
                });
                if (schema && Object.keys(schema).length) {
                    table = table.map((item) => {
                        var newItem = {};
                        var keys = Object.keys(schema);
                        for (let i = 0; i < keys.length; i++) {
                            newItem[keys[i]] = item[i];
                        }
                        return newItem;
                    });
                } else {
                    table = table.map((item) => {
                        return [null].concat(item);
                    });
                }
                $('#form-' + id).val(JSON.stringify(table));
            } catch (e) {
                alert('Table is invalid!');
                return false;
            }
        }
        document.getElementById('form').submit();
    }
</script>

<% include footer %>
